<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="vector.js"></script>
        <script type="text/javascript" src="player.js"></script>
        <script type="text/javascript" src="tile.js"></script>
        <script type="text/javascript" src="map.js"></script>
        <script type="text/javascript" src="sprite.js"></script>
        <script type="text/javascript" src="bullet.js"></script>
        <script type="text/javascript" src="priorityqueue.js"></script>
        <script type="text/javascript" src="enemy.js"></script>
        <script type="text/javascript" src="door.js"></script>
        <script type="text/javascript" src="raycasting.js"></script>
        <script>
            var previewWidth = 600;
            var previewHeight = 240;
            var gameResWidth = 320;
            var gameResHeight = 240;
            var origX = 0;
            var origY = previewHeight;
            var aspectRatio = gameResWidth / gameResHeight;
            var prevTime = 0;
            var canvas, context, canvasGame, contextGame;
            var player = null;
            var map = null;
            var enemy = null;
            var raycasting = null;
            var sprites = [];
            var outputWidth = gameResWidth; //gameResWidth * 2;
            var pixelWidth = outputWidth / gameResWidth;
            var outputHeight = outputWidth / aspectRatio;
            var distToPlane = 0;
            
            window.onload = function() {
                canvas = document.getElementById("canvas");
                context = canvas.getContext("2d");
                canvas.width = previewWidth;
                canvas.height = previewHeight;
                canvasGame = document.getElementById("game");
                contextGame = canvasGame.getContext("2d");
                canvasGame.width = outputWidth;
                canvasGame.height = outputHeight;
                map = new Map();
                var playerX = map.tileLength * 1 + map.tileLength / 2;
                var playerY = map.tileLength * 1 + map.tileLength / 2; 
                player = new Player(playerX, playerY, 10);
                sprites.push(new Sprite(map.tileLength * 3 + map.tileLength / 2, map.tileLength * 4, 10));
                sprites.push(new Sprite(map.tileLength * 8 + map.tileLength / 2, map.tileLength * 3, 10));
                raycasting = new Raycasting(gameResWidth);
                distToPlane = (outputWidth / 2) / Math.tan(raycasting.fov / 2);
                enemy = new Enemy(6, 4);
                document.onkeydown = onKeyDown;
                document.onkeyup = onKeyUp;
                requestAnimationFrame(update);
            };
            
            function update(time) {
                var dt = (time - prevTime) / 1000;
                prevTime = time;
                var fps = parseInt(1 / dt);
                context.clearRect(0, 0, previewWidth, previewHeight);
                context.fillText(fps, previewWidth - 10, 10);
                var a = 0;
                for (let tile of map.tiles) {
                    tile.update(dt);
                    //tile.render(context);
                    
                    if (map.doors[a] !== undefined) {
                        map.doors[a].update(dt);
                    }
                    a++;
                }
                for (let sprite of sprites) {
                    sprite.update(dt);
                    //sprite.render(context);
                }
                player.update(dt);
                //player.render(context);
                var tmpData = raycasting.getData();
                
                tmpData.sort(function(o1, o2) {
                    return o1.z < o2.z ? 1 : o1.z > o2.z ? -1 : 0;
                });
                
                //enemy.update(dt);
                //enemy.render(context);
                
                contextGame.clearRect(0, 0, outputWidth, outputHeight);
                contextGame.fillText(fps, outputWidth - 10, 10);
                for (let data of tmpData) {
                    var halfY = outputHeight / 2;
                    if (data.door) {
                        var h = 30 / data.z * distToPlane;
                        contextGame.fillStyle = "#EFEFEF";
                        contextGame.fillRect(data.x, halfY - h / 2, pixelWidth, h);
                    } else if (data.sprite === null) {
                        var h = 30 / data.z * distToPlane;
                        contextGame.fillStyle = "#FAFAFA";
                        contextGame.fillRect(data.x, halfY - h / 2, pixelWidth, h);
                    } else {
                        contextGame.fillStyle = "#f1f1f1";
                        var len = 10 / data.z * distToPlane;
                        //contextGame.fillRect(data.x - len / 2, halfY - len / 2, len, len);
                    }
                }
                
                requestAnimationFrame(update);
            }
            
            function onKeyDown(evt) {
                if (evt.keyCode === 38) player.forward(true);
                if (evt.keyCode === 37) player.rotateLeft(true);
                if (evt.keyCode === 39) player.rotateRight(true);
                if (evt.keyCode === 32) player.shoot(true);
            }
            
            function onKeyUp(evt) {
                if (evt.keyCode === 38) player.forward(false);
                if (evt.keyCode === 37) player.rotateLeft(false);
                if (evt.keyCode === 39) player.rotateRight(false);
                if (evt.keyCode === 32) player.shoot(false);
            }
        </script>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <canvas id="game"></canvas>
    </body>
</html>
